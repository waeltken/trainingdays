(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{757:function(t,s,e){t.exports=e.p+"assets/img/swagger-api.2725da9f.png"},758:function(t,s,e){t.exports=e.p+"assets/img/swagger-external.307344cc.png"},759:function(t,s,e){t.exports=e.p+"assets/img/ingress_controller.fe805702.png"},760:function(t,s,e){t.exports=e.p+"assets/img/default_ingress.fbdd941a.png"},761:function(t,s,e){t.exports=e.p+"assets/img/ingress_contacts.b0be9d4b.png"},762:function(t,s,e){t.exports=e.p+"assets/img/ui_home.5e34d60f.png"},763:function(t,s,e){t.exports=e.p+"assets/img/ui_list.67153dd4.png"},764:function(t,s,e){t.exports=e.p+"assets/img/ui_detail.c7f8e689.png"},851:function(t,s,e){"use strict";e.r(s);var a=e(44),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"basic-kubernetes-concepts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#basic-kubernetes-concepts"}},[t._v("#")]),t._v(" Basic Kubernetes Concepts")]),t._v(" "),a("h2",{attrs:{id:"prerequisites"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites"}},[t._v("#")]),t._v(" Prerequisites")]),t._v(" "),a("p",[t._v("In order to be able to store the custom Docker images you will be creating throughout this workshop, we need a container registry. Azure provides its own service for that, the Azure Container Registry. Let's create one via the Azure CLI:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ az group create --name adc-acr-rg --location westeurope\n$ az acr create --name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" --resource-group adc-acr-rg --sku basic --admin-enabled\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# now let's attach the container registry to the cluster")]),t._v("\n\n$ az aks update --resource-group adc-aks-rg --name adc-cluster --attach-acr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("h2",{attrs:{id:"build-a-custom-image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#build-a-custom-image"}},[t._v("#")]),t._v(" Build a custom image")]),t._v(" "),a("p",[t._v("First, let's build a custom Docker image. Go to the folder "),a("code",[t._v("day7/challenges/samples/challenge-2/singlecontainer")]),t._v(". Take a look at the - very simple - Dockerfile and run the following commands.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker build -t test:1.0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\ndocker run -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":80 test:1.0\n")])])]),a("p",[t._v("Open your browser and navigate to "),a("code",[t._v("http://localhost:8080")]),t._v(". You should see a page with a welcome message.")]),t._v(" "),a("p",[t._v("Now let's push the image to our registry. To be able to interact with our registry, we first need to login.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ACRPWD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("az acr credential show -n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" --query "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"passwords[0].value"')]),t._v(" -o tsv"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\ndocker login "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io -u "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" -p "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$ACRPWD")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("In this sample, we used the "),a("code",[t._v("admin")]),t._v(" account of our registry to login - basically with username/password. In secure/production environments, you should not enable the "),a("code",[t._v("admin")]),t._v(" account on the registry and login via Azure Active Directory: "),a("code",[t._v("az acr login -n <ACR_NAME>")]),t._v(". The token that is issued will be valid for 3 hours.")])]),t._v(" "),a("p",[t._v("We are now ready to push the image to our container registry.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker tag test:1.0 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/test:1.0\ndocker push "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/test:1.0\n")])])]),a("p",[t._v("You can also build directly within the Azure Container Registry service, in case you don't have Docker on your machine. Let's have a try...")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("az acr build -r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" -t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/test:2.0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),a("p",[t._v("The command will send the current build context to Azure, kick-off a docker build and add the image to your registry.")]),t._v(" "),a("h2",{attrs:{id:"run-your-custom-image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-your-custom-image"}},[t._v("#")]),t._v(" Run your custom image")]),t._v(" "),a("p",[t._v("Now that we have an image in our container registry, let's create a pod. This time, we will be using a YAML manifest.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file myfirstpod.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfirstpod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <ACR_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(".azurecr.io/test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfirstpod\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Never\n")])])]),a("p",[t._v("Create a file called "),a("code",[t._v("myfirstpod.yaml")]),t._v(" with the content above and apply it to your cluster.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("kubectl apply -f myfirstpod.yaml\n")])])]),a("blockquote",[a("p",[a("strong",[t._v("HINT")]),t._v(": If you could not connect your Azure Container Registry to the cluster due to missing permissions, use an "),a("RouterLink",{attrs:{to:"/day7/challenges/image-pull-secret.html"}},[t._v("Image Pull Secret")]),t._v(" to grant your Kubernetes cluster the rights to pull images from your private registry.")],1)]),t._v(" "),a("p",[t._v("Check that everything works as expected:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get pods -w\nNAME         READY   STATUS              RESTARTS   AGE\nmyfirstpod   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     ContainerCreating   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          6s\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("after a few seconds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nmyfirstpod   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          17s\n")])])]),a("p",[t._v('Also, "describe" the pod to see some more details like status, the node it\'s running on, events etc.')]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl describe pod myfirstpod\nName:         myfirstpod\nNamespace:    default\nPriority:     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nNode:         aks-nodepool1-11985439-vmss000001/10.240.0.5\nStart Time:   Thu, 08 Oct "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(":03:55 +0200\nLabels:       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nAnnotations:  Status:  Running\nIP:           "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".2.5\nIPs:\n  IP:  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".2.5\nContainers:\n  myfirstpod:\n    Container ID:   docker://2dc2e9ef913a6985fe355bd871666bd6eec859eba544c051eb3b5db5d7eeb1ab\n    Image:          adccontainerreg.azurecr.io/test:2.0\n    Image ID:       docker-pullable://adccontainerreg.azurecr.io/test@sha256:0e6b51d93fd3769bda02b5865491092a595194ea04f5b8bd8f6209f101bde724\n    Port:           "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/TCP\n    Host Port:      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/TCP\n    State:          Running\n      Started:      Thu, 08 Oct "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(":03:56 +0200\n    Ready:          True\n    Restart Count:  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    Environment:    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-9lb48 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ro"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nConditions:\n  Type              Status\n  Initialized       True\n  Ready             True\n  ContainersReady   True\n  PodScheduled      True\nVolumes:\n  default-token-9lb48:\n    Type:        Secret "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a volume populated by a Secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    SecretName:  default-token-9lb48\n    Optional:    "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\nQoS Class:       BestEffort\nNode-Selectors:  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nTolerations:     node.kubernetes.io/not-ready:NoExecute "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" 300s\n                 node.kubernetes.io/unreachable:NoExecute "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" 300s\nEvents:\n  Type    Reason     Age   From                                        Message\n  ----    ------     ----  ----                                        -------\n  Normal  Scheduled  13s   default-scheduler                           Successfully assigned default/myfirstpod to aks-nodepool1-11985439-vmss000001\n  Normal  Pulled     12s   kubelet, aks-nodepool1-11985439-vmss000001  Container image "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"adccontainerreg.azurecr.io/test:2.0"')]),t._v(" already present on machine\n  Normal  Created    12s   kubelet, aks-nodepool1-11985439-vmss000001  Created container myfirstpod\n  Normal  Started    12s   kubelet, aks-nodepool1-11985439-vmss000001  Started container myfirstpod\n")])])]),a("h2",{attrs:{id:"port-forwarding"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#port-forwarding"}},[t._v("#")]),t._v(" Port-Forwarding")]),t._v(" "),a("p",[t._v("So, the pod is running, but how do we access it?! Let's have a look at one option, that you typically would use in "),a("em",[t._v("test/debug")]),t._v(" scenarios.")]),t._v(" "),a("p",[t._v("With "),a("code",[t._v("kubectl")]),t._v(' you can "port-forward" a local port to a port on a pod. This is how it works in our case:')]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("kubectl port-forward myfirstpod "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":80\n")])])]),a("p",[t._v("Our pod is listening on port "),a("code",[t._v("80")]),t._v(" and we forward our local port "),a("code",[t._v("8080")]),t._v(" to that one. You can check the result by navigating - once again - to "),a("code",[t._v("http://localhost:8080")]),t._v(".")]),t._v(" "),a("p",[t._v("To proof that the requests arrive at the pod, check the logs:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl logs myfirstpod -f"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true\n/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration\n/docker-entrypoint.sh: Looking "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" shell scripts "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /docker-entrypoint.d/\n/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-listen-on-ipv6-by-default.sh: Getting the checksum of /etc/nginx/conf.d/default.conf\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-listen-on-ipv6-by-default.sh: Enabled listen on IPv6 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /etc/nginx/conf.d/default.conf\n/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh\n/docker-entrypoint.sh: Configuration complete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ready "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" start up\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1 - - "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("08/Oct/2020:12:09:04 +0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET / HTTP/1.1"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("171")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36 Edg/85.0.564.70"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1 - - "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("08/Oct/2020:12:09:04 +0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET / HTTP/1.1"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("304")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36 Edg/85.0.564.70"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1 - - "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("08/Oct/2020:12:09:04 +0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET / HTTP/1.1"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("304")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36 Edg/85.0.564.70"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1 - - "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("08/Oct/2020:12:09:04 +0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET / HTTP/1.1"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("304")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36 Edg/85.0.564.70"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-"')]),t._v("\n")])])]),a("h2",{attrs:{id:"running-multiple-instances-of-our-workload"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#running-multiple-instances-of-our-workload"}},[t._v("#")]),t._v(" Running multiple instances of our workload")]),t._v(" "),a("p",[t._v("Until now we only showed, how Kubernetes is dealing with single container/pod environments. If such a pod fails (something serious happens and the process crashes e.g.), Kubernetes doesn't take care of restarting our workload. On top of that, we only run a single instance - ideally, we can tell Kubernetes to run multiple instances of our container in the cluster. To give Kubernetes more control over the application/service we want to run, we need to use another object to deploy our container(s): "),a("code",[t._v("Deployments")]),t._v(".")]),t._v(" "),a("h3",{attrs:{id:"deployments"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deployments"}},[t._v("#")]),t._v(" Deployments")]),t._v(" "),a("p",[t._v("In a "),a("code",[t._v("Deployment")]),t._v(", you can tell Kubernetes a few more things, that you definitely need in production environments:")]),t._v(" "),a("ul",[a("li",[t._v("number of instances of our container/pod")]),t._v(" "),a("li",[t._v("how to do the upgrade, in case we deploy the next version of our service (e.g. always keep two instances up and running)")])]),t._v(" "),a("p",[t._v("So let's do this...the service that we are going to deploy needs a SQL server instance to connect to. Therefor, we deploy a Microsoft SQL Server 2019 instance into our cluster that we then can use from our service.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file sqlserver.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mssql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mssql\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mssql\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("terminationGracePeriodSeconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("fsGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10001")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mssql\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mcr.microsoft.com/mssql/server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("2019"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1433")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" MSSQL_PID\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Developer'")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ACCEPT_EULA\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Y'")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" SA_PASSWORD\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Ch@ngeMe!23'")]),t._v("\n")])])]),a("p",[t._v("Create a file called "),a("code",[t._v("sqlserver.yaml")]),t._v(" and apply the configuration.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -f sqlserver.yaml\n\ndeployment.apps/mssql-deployment created\n\n$ kubectl get pods -w\n\nNAME                                READY   STATUS              RESTARTS   AGE\nmssql-deployment-5559884974-q2j4w   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     ContainerCreating   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          5s\nmssql-deployment-5559884974-q2j4w   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          39s\n")])])]),a("p",[t._v("After about 30-40 sec, you should see that the pod with SQL Server 2019 is up and running. Also, let's have a look at the deployment.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get deployments\n\nNAME               READY   UP-TO-DATE   AVAILABLE   AGE\nmssql-deployment   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("           100s\n\n$ kubectl describe deployment mssql-deployment\n\nName:                   mssql-deployment\nNamespace:              default\nCreationTimestamp:      Tue, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),t._v(" Oct "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 09:34:28 +0100\nLabels:                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nAnnotations:            deployment.kubernetes.io/revision: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nSelector:               "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mssql\nReplicas:               "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" desired "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" updated "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" total "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" available "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" unavailable\nStrategyType:           RollingUpdate\nMinReadySeconds:        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nRollingUpdateStrategy:  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v("% max unavailable, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v("% max surge\nPod Template:\n  Labels:  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mssql\n  Containers:\n   mssql:\n    Image:      mcr.microsoft.com/mssql/server:2019-latest\n    Port:       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1433")]),t._v("/TCP\n    Host Port:  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/TCP\n    Environment:\n      MSSQL_PID:    Developer\n      ACCEPT_EULA:  Y\n      SA_PASSWORD:  Ch@ngeMe"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v("\n    Mounts:         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  Volumes:          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nConditions:\n  Type           Status  Reason\n  ----           ------  ------\n  Available      True    MinimumReplicasAvailable\n  Progressing    True    NewReplicaSetAvailable\nOldReplicaSets:  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nNewReplicaSet:   mssql-deployment-5559884974 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1 replicas created"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nEvents:\n  Type    Reason             Age    From                   Message\n  ----    ------             ----   ----                   -------\n  Normal  ScalingReplicaSet  2m25s  deployment-controller  Scaled up replica "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" mssql-deployment-5559884974 to "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])]),a("p",[t._v("As we need to connect to this pod over the network, let's find out what IP address has been assigned to it.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get pods -o wide\n\nNAME                                READY   STATUS    RESTARTS   AGE     IP           NODE                                NOMINATED NODE   READINESS GATES\nmssql-deployment-5559884974-q2j4w   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          4m44s   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.5   aks-nodepool1-11985439-vmss000000   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("The address may vary in your environment, for the sample here, it's "),a("code",[t._v("10.244.0.5")]),t._v(". Please note the address down, as you will need it in the next step.")]),t._v(" "),a("p",[t._v("Now, we can deploy a simple API that is able to manage "),a("code",[t._v("Contacts")]),t._v(" objects, that means Create/Read/Update/Delete contacts of a very simple CRM app. The image needs to be built upfront and put in your container registry. So, please go to the folder "),a("code",[t._v("day7/apps/dotnetcore/Scm")]),t._v(" and build the API image:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ docker build -t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/adc-api-sql:1.0 -f ./Adc.Scm.Api/Dockerfile "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\nSending build context to Docker daemon  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(".51kB\nStep "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/11 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" FROM mcr.microsoft.com/dotnet/core/sdk:3.1 AS build\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.1")]),t._v(": Pulling from dotnet/core/sdk\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nStep "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("/11 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("USER")]),t._v(" www-data\n ---"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Running "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 50fb1d57ca84\nRemoving intermediate container 50fb1d57ca84\n ---"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 4264f8b474b6\nStep "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v("/11 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" ENTRYPOINT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dotnet"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Adc.Scm.Api.dll"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n ---"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Running "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" bbd3e574d650\nRemoving intermediate container bbd3e574d650\n ---"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" b4a8315645be\nSuccessfully built b4a8315645be\nSuccessfully tagged adccontainerreg.azurecr.io/adc-api-sql:1.0\n")])])]),a("p",[t._v("After a successful build, push the local image to the Azure Container Registry:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ docker push "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/adc-api-sql:1.0\n\nThe push refers to repository "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("adccontainerreg.azurecr.io/adc-api-sql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n11185412b6d4: Pushed\nafe1f320f2da: Pushed\n42a28097962e: Pushed\n049b0fdaa27c: Pushed\n87e08e237115: Pushed\n1915427dc1a4: Pushed\n8a939c4fd477: Pushed\nd0fe97fa8b8c: Mounted from "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v(": digest: sha256:b10195ef4c4f4efe1c8ace700ae24121f236ab73e91f2d6dce8d78d82b3967ec size: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2006")]),t._v("\n")])])]),a("p",[t._v("There is also another approach - you can also build directly within the container registry. Let's do this:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("az acr build -r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" -t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/adc-api-sql:1.0 -f ./Adc.Scm.Api/Dockerfile "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),a("p",[t._v("Now we are ready to use the image in our deployment:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file api.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapi\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapi\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapi\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapi\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ConnectionStrings__DefaultConnectionString\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Server=tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("<IP_OF_THE_SQL_POD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("1433;Initial Catalog=scmcontactsdb;Persist Security Info=False;User ID=sa;Password=Ch@ngeMe"),a("span",{pre:!0,attrs:{class:"token tag"}},[t._v("!23;MultipleActiveResultSets=False;Encrypt=False;TrustServerCertificate=True;Connection")]),t._v(" Timeout=30;\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <ACR_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(".azurecr.io/adc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'128Mi'")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'500m'")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v("\n")])])]),a("p",[t._v("A few notes on the deployment above. First and foremost, we tell Kubernetes to run 4 replicas of our service "),a("code",[t._v("replicas: 4")]),t._v(". We also configure the pod to set an environment variable called "),a("code",[t._v("ConnectionStrings__DefaultConnectionString")]),t._v(" which contains the connection string to the database (the API will use this env variable to get the connection string). Please replace <IP_OF_THE_SQL_POD> with the correct IP address. We also set resource limits and expose port "),a("code",[t._v("5000")]),t._v(", so that the API can be reached from outside of the pod.")]),t._v(" "),a("p",[t._v("Again, create a file ("),a("code",[t._v("api.yaml")]),t._v(") with the contents above - don't forget to replace the IP address - and apply the configuration to your cluster.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -f api.yaml\n\ndeployment.apps/myapi created\n")])])]),a("p",[t._v("Let's have a look at the pods...we should now have 4 replicas running in the cluster.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get pods\n\nNAME                                READY   STATUS    RESTARTS   AGE\nmssql-deployment-5559884974-q2j4w   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          23m\nmyapi-7c74475b88-7hmcj              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          74s\nmyapi-7c74475b88-7jhtq              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          74s\nmyapi-7c74475b88-jzmcx              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          74s\nmyapi-7c74475b88-s5gmj              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          74s\n")])])]),a("p",[t._v('We are all set to test the API and the connection to the SQL server. As done before, let\'s "port-forward" a local port to a pod in the Kubernetes cluster. You can pick any of the four running API pods. In the sample here, we take pod '),a("code",[t._v("myapi-7c74475b88-7hmcj")]),t._v(" - of course, replace the pod name with one from your environment.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl port-forward myapi-7c74475b88-7hmcj "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":5000\n\nForwarding from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:8080 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v("\nForwarding from "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("::1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":8080 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v("\nHandling connection "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\nHandling connection "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\nHandling connection "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n")])])]),a("p",[t._v("You can now open a browser and navigate to "),a("code",[t._v("http://localhost:8080")]),t._v(". If everything is fine, you will see the Swagger UI of the API:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(757),alt:"SwaggerUI"}})]),t._v(" "),a("p",[t._v("Try out the API, e.g. create a contact via "),a("code",[t._v("POST")]),t._v(" method, read (all) contacts via the "),a("code",[t._v("GET")]),t._v(" operations etc.")]),t._v(" "),a("h3",{attrs:{id:"failover-health"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#failover-health"}},[t._v("#")]),t._v(" Failover / Health")]),t._v(" "),a("p",[t._v('As discussed before, Kubernetes takes care of your deployments by constantly checking the state of it and if anything is not the way it is supposed to be, Kubernetes tries to "heal" the corresponding deployment. E.g. when a pod of a deployment gets deleted (for any reason) and the deployment - as in our case - defines to have 4 replicas of the service, your cluster will notice the difference and re-creates the 4th pod again to reestablish the desired state.')]),t._v(" "),a("p",[t._v("Let's try this...first, let's query the pods in our cluster. An this time, we are \"watching\" ("),a("code",[t._v("-w")]),t._v(") them so that we get notified of any changes of their states:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get pods -w\n\nNAME                                READY   STATUS    RESTARTS   AGE\nmssql-deployment-5559884974-q2j4w   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          58m\nmyapi-7c74475b88-7hmcj              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          36m\nmyapi-7c74475b88-7jhtq              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          36m\nmyapi-7c74475b88-jzmcx              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          36m\nmyapi-7c74475b88-s5gmj              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          36m\n")])])]),a("p",[t._v("Now please open another tab/command line window and kill one of the pods. Here, we pick "),a("code",[t._v("myapi-7c74475b88-7jhtq")]),t._v(" - again, replace the pod name with one from your environment.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl delete pod myapi-7c74475b88-7jhtq\n\npod "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"myapi-7c74475b88-7jhtq"')]),t._v(" deleted\n")])])]),a("p",[t._v('In the first tab/window where we are watching for "pod changes", you should now see a similar output...')]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("myapi-7c74475b88-7jhtq              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Terminating   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          45m\nmyapi-7c74475b88-rpv8x              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Pending       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          0s\nmyapi-7c74475b88-rpv8x              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Pending       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          0s\nmyapi-7c74475b88-rpv8x              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     ContainerCreating   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          0s\nmyapi-7c74475b88-7jhtq              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Terminating         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          45m\nmyapi-7c74475b88-rpv8x              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          2s\nmyapi-7c74475b88-7jhtq              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Terminating         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          45m\nmyapi-7c74475b88-7jhtq              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Terminating         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          45m\n")])])]),a("p",[t._v("As you can see, Kubernetes immediately starts a new pod ("),a("code",[t._v("myapi-7c74475b88-rpv8x")]),t._v("), because for a certain amount of time, there are only 3 pods running/available in the cluster. And in the deployment, we told Kubernetes to always have 4 pods of them present.")]),t._v(" "),a("h3",{attrs:{id:"scale-on-purpose"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#scale-on-purpose"}},[t._v("#")]),t._v(" Scale on purpose")]),t._v(" "),a("p",[t._v("Of course, you can scale such a deployment on purpose to e.g. 3 or 6 replicas. Therefor, you should use the "),a("code",[t._v("scale")]),t._v(" command (or simply edit the deployment manifest). Kubernetes will then kill or create the corresponding amount of pods to fulfill the request. Try it out:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Scale up to 6 replicas")]),t._v("\n$ kubectl scale deployment --replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" myapi\n\ndeployment.apps/myapi scaled\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# kubectl get pods should now show 6 "myapi"-pods')]),t._v("\n")])])]),a("p",[t._v("Now we learned how to scale containers/pods and how Kubernetes behaves when the desired state is different from the actual state. But still there is no way to access our pods, except via IP adresses within the cluster. It even got worse, because we now have multiple pods running. We would need to find out all IP addresses of our pods to being able to send requests to them. This is not ideal. So, let's introduce another object called "),a("code",[t._v("Service")]),t._v(" to have a common, load-balanced endpoint for all of our pods.")]),t._v(" "),a("h2",{attrs:{id:"services"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#services"}},[t._v("#")]),t._v(" Services")]),t._v(" "),a("p",[t._v("Kubernetes comes with its own service discovery component, called "),a("code",[t._v("Service")]),t._v(". A service is a way to expose a set of pods as a network endpoint with a unique name. This is very useful, because as you saw in the previous chapters, Kubernetes automatically creates and destroys pods to match the state of your cluster, IP addresses therefor change or aren't valid the next time you would call such a pod. So, the "),a("code",[t._v("Service")]),t._v(" is the one component that keeps track of what pods make up a certain service (and what IP addresses are valid to call) - and is also able to load-balance traffic across those pods.")]),t._v(" "),a("p",[t._v("To be able to determine which pods form a service, Kubernetes uses "),a("code",[t._v("Labels")]),t._v(" and "),a("code",[t._v("LabelSelectors")]),t._v(": you assign labels to a (set of) pod(s) e.g. "),a("code",[t._v("app = myapi")]),t._v(" and the corresponding service uses the same key/value combination as selector.")]),t._v(" "),a("p",[t._v("There are different types of services you can create in Kubernetes, let's dive into some of them...")]),t._v(" "),a("h2",{attrs:{id:"clusterip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#clusterip"}},[t._v("#")]),t._v(" ClusterIP")]),t._v(" "),a("p",[t._v("The default service type in Kubernetes is called "),a("code",[t._v("ClusterIP")]),t._v(". If you choose that type, the service will be exposed via a cluster-internal IP adress and is therefor only reachable from within the cluster.")]),t._v(" "),a("p",[t._v("Let's see it in action...")]),t._v(" "),a("p",[t._v("For this sample, we will be re-using the deployment and pods we created in the previous chapter (Contacts REST API and a SQL server running in the cluster).\nLet's scale the API deployment back down to 4 replicas in case you haven't already done so.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl scale deployment --replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" myapi\n\ndeployment.apps/myapi scaled\n")])])]),a("p",[t._v("After executing that command, the current state should look similar to that one:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get pods,deployments,services\n\nNAME                                    READY   STATUS    RESTARTS   AGE\npod/mssql-deployment-5559884974-q2j4w   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          6h9m\npod/myapi-7c74475b88-67s7w              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          49s\npod/myapi-7c74475b88-jzmcx              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          5h47m\npod/myapi-7c74475b88-s5gmj              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          5h47m\npod/myapi-7c74475b88-vhw6n              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          49s\n\nNAME                               READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/mssql-deployment   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("           6h9m\ndeployment.apps/myapi              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("/4     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("           5h47m\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   AGE\nservice/kubernetes   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".0.1     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP   5d1h\n")])])]),a("p",[t._v("In the previous deployment, we already added "),a("code",[t._v("Labels")]),t._v(" without really knowing what they are good for 😃. Here's the excerpt of one the YAML manifests:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapi\n")])])]),a("p",[t._v("So, let's see, if we have these labels attached to the API pods.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("kubectl get pods --show-labels -o wide\n\nNAME                                READY   STATUS    RESTARTS   AGE     IP            NODE                                NOMINATED NODE   READINESS GATES   LABELS\nmssql-deployment-5559884974-q2j4w   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          6h42m   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.5    aks-nodepool1-11985439-vmss000000   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("mssql,pod-template-hash"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5559884974")]),t._v("\nmyapi-7c74475b88-67s7w              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          34m     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.15   aks-nodepool1-11985439-vmss000000   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("myapi,pod-template-hash"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("7c74475b88\nmyapi-7c74475b88-jzmcx              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          6h20m   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".2.4    aks-nodepool1-11985439-vmss000002   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("myapi,pod-template-hash"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("7c74475b88\nmyapi-7c74475b88-s5gmj              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          6h20m   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".1.8    aks-nodepool1-11985439-vmss000001   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("myapi,pod-template-hash"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("7c74475b88\nmyapi-7c74475b88-vhw6n              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          34m     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.16   aks-nodepool1-11985439-vmss000000   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("myapi,pod-template-hash"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("7c74475b88\n")])])]),a("p",[t._v("Looks good! As you can see, the SQL server pod also already has some labels ("),a("code",[t._v("app=mssql")]),t._v("). Now, let's add two services: one for the SQL server (remember, we used the IP address in the connection string, which is really bad as we now know) and one for the API pods.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file sqlserver-service.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mssqlsvr\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mssql\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1433")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1433")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# could be omitted, because 'port' and 'targetPort' are the same")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterIP "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# could be omitted, because ClusterIP is the default type")]),t._v("\n")])])]),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file api-service.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" contactsapi\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapi\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 'external' port...")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 'internal' port...")]),t._v("\n")])])]),a("p",[t._v("Let's apply both definitions.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -f sqlserver-service.yaml\nservice/mssqlsvr created\n\n$ kubectl apply -f api-service.yaml\nservice/contactsapi created\n")])])]),a("p",[t._v("So, how do we check, that the service(s) really find pods to route traffic to? Therefor, another Kubernetes object comes into play: "),a("code",[t._v("Endpoints")]),t._v(". An endpoint tracks the IP addresses of individual pods and is created for each service you define. The service then references an endpoint to know to which pods traffic can be routed to. Any time a pod gets created or deleted (and is part of a certain service), the corresponding "),a("code",[t._v("Endpoint")]),t._v(" gets updated.")]),t._v(" "),a("p",[t._v("Let's see how that looks like in our case.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get services,endpoints\n\nNAME                  TYPE        CLUSTER-IP    EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("    AGE\nservice/contactsapi   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".49.134   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("/TCP   8m21s\nservice/kubernetes    ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".0.1      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP    5d1h\nservice/mssqlsvr      ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".96.4     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1433")]),t._v("/TCP   8m21s\n\nNAME                    ENDPOINTS                                                       AGE\nendpoints/contactsapi   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.15:5000,10.244.0.16:5000,10.244.1.8:5000 + "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" more"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".   8m22s\nendpoints/kubernetes    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20.50")]),t._v(".162.80:443                                                5d1h\nendpoints/mssqlsvr      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.5:1433                                                 8m22s\n")])])]),a("p",[t._v("This looks pretty good! The services we added have been created and also their corresponding endpoints point to the correct pod IP addresses. In case of the "),a("code",[t._v("contactsapi")]),t._v(" service/endpoint, it finds multiple pods/IP addresses to route traffic to. From now on, we could use the service name to call our pods, e.g. "),a("a",{attrs:{href:"http://contactsapi:8080",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://contactsapi:8080"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v('Now, there is one more step to do, before we can test the setup: adjust the connection string of the "myapi" deployment.')]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ConnectionStrings__DefaultConnectionString\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Server=tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("mssqlsvr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("1433;Initial Catalog=scmcontactsdb;Persist Security Info=False;User ID=sa;Password=Ch@ngeMe"),a("span",{pre:!0,attrs:{class:"token tag"}},[t._v("!23;MultipleActiveResultSets=False;Encrypt=False;TrustServerCertificate=True;Connection")]),t._v(" Timeout=30;\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("Please replace the IP address, with the DNS name of the service "),a("code",[t._v("mssqlsvr")]),t._v(" and reapply the manifest. This will result in 4 re-created API pods.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -f api.yaml\ndeployment.apps/myapi configured\n")])])]),a("p",[t._v("Let's test the setup...we now spin up another pod in the cluster, connect to the commandline of that pod and run several calls against our API service.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl run -it --rm --image csaocpger/httpie:1.0 http --restart Never -- /bin/sh\nIf you don't see a "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" prompt, try pressing enter.\n")])])]),a("p",[t._v("You are now connected to the pod and should see a command prompt. We can now issue some requests.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# CREATE a contact")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{ "firstname": "Satya", "lastname": "Nadella", "email": "satya@microsoft.com", "company": "Microsoft", "avatarLocation": "", "phone": "+1 32 6546 6545", "mobile": "+1 32 6546 6542", "description": "CEO of Microsoft", "street": "Street", "houseNumber": "1", "city": "Redmond", "postalCode": "123456", "country": "USA" }\'')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http POST http://contactsapi:8080/contacts\n\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("201")]),t._v(" Created\nContent-Type: application/json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf-8\nDate: Wed, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" Oct "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 08:44:43 GMT\nLocation: http://contactsapi:8080/contacts/011a9848-2889-4164-a29e-d5ffca5d58cc\nServer: Kestrel\nTransfer-Encoding: chunked\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"avatarLocation"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"city"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Redmond"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"company"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Microsoft"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"country"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"USA"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"description"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CEO of Microsoft"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"email"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"satya@microsoft.com"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"firstname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Satya"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"houseNumber"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"011a9848-2889-4164-a29e-d5ffca5d58cc"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lastname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Nadella"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mobile"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"+1 32 6546 6542"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"phone"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"+1 32 6546 6545"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"postalCode"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123456"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"street"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Street"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# READ all contacts")]),t._v("\nhttp GET http://contactsapi:8080/contacts\n\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\nContent-Type: application/json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf-8\nDate: Wed, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" Oct "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 08:45:49 GMT\nServer: Kestrel\nTransfer-Encoding: chunked\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"avatarLocation"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"city"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Redmond"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"company"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Microsoft"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"country"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"USA"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"description"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CEO of Microsoft"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"email"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"satya@microsoft.com"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"firstname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Satya"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"houseNumber"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"011a9848-2889-4164-a29e-d5ffca5d58cc"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lastname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Nadella"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mobile"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"+1 32 6546 6542"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"phone"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"+1 32 6546 6545"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"postalCode"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123456"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"street"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Street"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("As you can see, the API is working perfectly...and, traffic is load-balanced over the 4 running pods of the contacts API. Also, the connection from an API pod to the database via the "),a("code",[t._v("Service")]),t._v(" is working as expected.")]),t._v(" "),a("h2",{attrs:{id:"nodeport-optional"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodeport-optional"}},[t._v("#")]),t._v(" NodePort (Optional)")]),t._v(" "),a("p",[t._v("So far, we have learned about the default service type in Kubernetes (ClusterIP). The next one we'll cover is called "),a("code",[t._v("NodePort")]),t._v(". A "),a("code",[t._v("NodePort")]),t._v(" service exposes the service on each worker node at a static port. You'll be able to call the service from outside the cluster, even the internet, if the node had a public IP address. By default, also a ClusterIP service, to which the NodePort service routes, is automatically created.")]),t._v(" "),a("p",[t._v("To demonstrate the behavior, we'll create a new service called "),a("code",[t._v("nodeport-contactsapi")]),t._v(" that will select all of the API pods currently running in the cluster - basically the same behavior as the ClusterIP service, but accessible via <NodeIp>:<NodePort>.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file api-service-nodeport.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nodeport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("contactsapi\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" NodePort\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapi\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 'clusterip' port...")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 'internal' port...")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodePort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30010")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# optional - Kubernetes would pick a port from the default node-port range 30000-32767")]),t._v("\n")])])]),a("p",[t._v("Create a file called "),a("code",[t._v("api-service-nodeport.yaml")]),t._v(" and apply the definition to your cluster.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -f api-service-nodeport.yaml\n\nservice/nodeport-contactsapi created\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Check the services/endpoints created")]),t._v("\n$ kubectl get services,endpoints\n")])])]),a("p",[t._v("By using the same label selectors for the service, we get the same endpoints as for our "),a("code",[t._v("ClusterIP")]),t._v(" API service.")]),t._v(" "),a("p",[t._v("Now, let's call such a service via a node's IP address and the port "),a("code",[t._v("30010")]),t._v(". We first need to determine the IP address of each node.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# get node IP adresses")]),t._v("\n$ kubectl get nodes -o wide\n\nNAME                                STATUS   ROLES   AGE     VERSION    INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME\naks-nodepool1-11985439-vmss000000   Ready    agent   5d20h   v1.17.11   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.240")]),t._v(".0.4    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        Ubuntu "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16.04")]),t._v(".7 LTS   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.15")]),t._v(".0-1096-azure   docker://19.3.12\naks-nodepool1-11985439-vmss000001   Ready    agent   5d20h   v1.17.11   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.240")]),t._v(".0.5    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        Ubuntu "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16.04")]),t._v(".7 LTS   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.15")]),t._v(".0-1096-azure   docker://19.3.12\naks-nodepool1-11985439-vmss000002   Ready    agent   5d20h   v1.17.11   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.240")]),t._v(".0.6    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        Ubuntu "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16.04")]),t._v(".7 LTS   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.15")]),t._v(".0-1096-azure   docker://19.3.12\n")])])]),a("p",[t._v("In this case, we have the IP addresses "),a("code",[t._v("10.240.0.4")]),t._v(", "),a("code",[t._v("10.240.0.5")]),t._v(" and "),a("code",[t._v("10.240.0.6")]),t._v(". Let's use one of them to call the contacts API.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl run -it --rm --image csaocpger/httpie:1.0 http --restart Never -- /bin/sh\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# inside the pod, execute...")]),t._v("\n\n$ http GET http://10.240.0.4:30010/contacts\n\nHTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\nContent-Type: application/json"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf-8\nDate: Wed, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" Oct "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 09:45:58 GMT\nServer: Kestrel\nTransfer-Encoding: chunked\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"avatarLocation"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"city"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Redmond"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"company"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Microsoft"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"country"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"USA"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"description"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CEO of Microsoft"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"email"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"satya@microsoft.com"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"firstname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Satya"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"houseNumber"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"011a9848-2889-4164-a29e-d5ffca5d58cc"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lastname"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Nadella"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mobile"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"+1 32 6546 6542"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"phone"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"+1 32 6546 6545"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"postalCode"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123456"')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"street"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Street"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("Perfect! We can now also call our contacts API service via a worker node. But unfortunately, our worker nodes do not have a public IP adress. So how can we access our service now via the internet? Let's move on to the next service type: "),a("code",[t._v("LoadBalancer")]),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"loadbalancer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#loadbalancer"}},[t._v("#")]),t._v(" LoadBalancer")]),t._v(" "),a("p",[t._v("As you might already have guessed, a service of type "),a("code",[t._v("LoadBalancer")]),t._v(" is the one, that enables us to expose a service via an Azure Loadbalancer with a public IP adress. By default, also a "),a("code",[t._v("ClusterIP")]),t._v(" and "),a("code",[t._v("NodePort")]),t._v(" service, to which the external loadbalancer routes, are automatically created.")]),t._v(" "),a("p",[t._v("Let's see this in action. Again, we create an additional service that routes traffic to our 4 API pods, this time with a type of "),a("code",[t._v("LoadBalancer")]),t._v(".")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file api-service-loadbalancer.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" loadbalancer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("contactsapi\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" LoadBalancer\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myapi\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 'public' port...")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 'internal' port...")]),t._v("\n")])])]),a("p",[t._v("Please create a file called "),a("code",[t._v("api-service-loadbalancer.yaml")]),t._v(" and apply it.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -f api-service-loadbalancer.yaml\n\nservice/loadbalancer-contactsapi created\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Check available services in the cluster")]),t._v("\n\n$ kubectl get services -w\n\nNAME                       TYPE           CLUSTER-IP    EXTERNAL-IP      PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("          AGE\ncontactsapi                ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".49.134   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("/TCP         19h\nkubernetes                 ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".0.1      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP          5d21h\nloadbalancer-contactsapi   LoadBalancer   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".163.1    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("pending"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":30320/TCP   6s\nmssqlsvr                   ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".96.4     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1433")]),t._v("/TCP         19h\nnodeport-contactsapi       NodePort       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".87.165   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":30010/TCP   69m\nloadbalancer-contactsapi   LoadBalancer   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".163.1    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("52.236")]),t._v(".151.220   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":30320/TCP   56s\n")])])]),a("p",[t._v("As you can see, after a short amount of time, the "),a("code",[t._v("loadbalancer-contactsapi")]),t._v(" is receiving an external IP adress from the Azure Loadbalancer. Our contacts API should now be accessible - in this case - via "),a("a",{attrs:{href:"http://52.236.151.220:8080",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://52.236.151.220:8080"),a("OutboundLink")],1),t._v(". If you open that link in a browser (of course, replace the IP adress with the one your service has received), you should see the swagger UI.")]),t._v(" "),a("p",[a("img",{attrs:{src:e(758),alt:"swagger_external"}})]),t._v(" "),a("p",[t._v("We now have the tools to expose a single service to the internet via the "),a("code",[t._v("LoadBalancer")]),t._v(' type. This may be okay in a scenario, where you only have few services. But to be clear, this is a "bad pattern". In a production environment, you want to limit the amount of externally available services (IP adresses) to a minimum. And if your application is made of several services or is implementing a microservice-based architectural pattern, using '),a("code",[t._v("LoadBalancer")]),t._v(" services is a bad practice. Ideally, you only use one public IP adress and manage the external access to the cluster via "),a("code",[t._v("Ingress")]),t._v(" definitions and the corresponding "),a("code",[t._v("Ingress Controller")]),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"ingress"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ingress"}},[t._v("#")]),t._v(" Ingress")]),t._v(" "),a("p",[t._v("An "),a("code",[t._v("Ingress")]),t._v(" definition is a way to describe how clients are routed to your services. It manages the "),a("strong",[t._v("external")]),t._v(' access to your cluster, typically via http(s). It is a core concept of Kubernetes and the "rules" defined in an '),a("code",[t._v("Ingress")]),t._v(" manifest are always implemented by a third party controller, the "),a("code",[t._v("Ingress Controller")]),t._v(". Kubernetes doesn't come with one \"out-of-the-box\", but you can install one from a variety of offerings. We will be using the NGINX Ingress Controller, but here's an awesome comparion of all the (relevant) available options currently: "),a("a",{attrs:{href:"https://docs.google.com/spreadsheets/d/191WWNpjJ2za6-nbG4ZoUMXMpUK8KlCIosvQB0f-oq3k/htmlview#",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.google.com/spreadsheets/d/191WWNpjJ2za6-nbG4ZoUMXMpUK8KlCIosvQB0f-oq3k/htmlview#"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("The "),a("code",[t._v("Ingress Controller")]),t._v(" sits in front of many services within a cluster and is the (most of the time) the only service of type "),a("code",[t._v("LoadBalancer")]),t._v(" with a public IP in Kubernetes, routing traffic to your services and - depending on the implementation - can also add functionality like SSL termination, path rewrites, name based virtual hosts, IP whitelisting etc.")]),t._v(" "),a("p",[a("img",{attrs:{src:e(759),alt:"ingress controller"}})]),t._v(" "),a("h3",{attrs:{id:"installation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#installation"}},[t._v("#")]),t._v(" Installation")]),t._v(" "),a("p",[t._v("To install the "),a("a",{attrs:{href:"https://kubernetes.github.io/ingress-nginx/",target:"_blank",rel:"noopener noreferrer"}},[t._v("NGINX ingress controller"),a("OutboundLink")],1),t._v(", we will be using Helm. Helm is the defacto package manager in the Kubernetes universe. If you haven't installed it already, please go to "),a("a",{attrs:{href:"https://helm.sh/docs/intro/install/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://helm.sh/docs/intro/install/"),a("OutboundLink")],1),t._v(" and follow the instructions depending on the OS you are using. If you follow this workshop in the Azure Cloud Shell, you are good to go - it is already installed for you.")]),t._v(" "),a("p",[a("strong",[t._v("Important:")]),t._v(" To keeps things cleary seperated from each other, we will be using a different namespace for the ingress controller. "),a("a",{attrs:{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Kubernetes namespaces"),a("OutboundLink")],1),t._v(' are a way to logically group workloads within a cluster - they literally create a "virtual cluster" in your physical cluster.')]),t._v(" "),a("blockquote",[a("p",[t._v("By the way, you are already using namespaces! Every time you were deploying pods, services etc. to the cluster, you were using the "),a("code",[t._v("default")]),t._v(" namespace which has been created for you during cluster creation. You can list the available namespaces by executing "),a("code",[t._v("kubectl get namespaces")]),t._v(".")])]),t._v(" "),a("p",[t._v("Now, let's install the ingress controller:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# create ingress namespace")]),t._v("\n$ kubectl create namespace ingress\n\nnamespace/ingress created\n\n$ helm repo "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" ingress-nginx https://kubernetes.github.io/ingress-nginx\n\n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ingress-nginx"')]),t._v(" has been added to your repositories\n\n$ helm "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" my-ingress ingress-nginx/ingress-nginx --version "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.7")]),t._v(".1 --set controller.service.externalTrafficPolicy"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Local --namespace ingress\n\nNAME: my-ingress\nLAST DEPLOYED: Thu Oct "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29")]),t._v(" 08:11:35 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("\nNAMESPACE: ingress\nSTATUS: deployed\nREVISION: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nTEST SUITE: None\nNOTES:\nThe ingress-nginx controller has been installed.\nIt may take a few minutes "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" the LoadBalancer IP to be available.\nYou can "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("watch")]),t._v(" the status by running "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kubectl --namespace ingress get services -o wide -w my-ingress-ingress-nginx-controller'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("After the controller has been installed, check the correspondig service:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("\n$ kubectl --namespace ingress get services my-ingress-ingress-nginx-controller\n\nNAME                                  TYPE           CLUSTER-IP     EXTERNAL-IP     PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                      AGE\nmy-ingress-ingress-nginx-controller   LoadBalancer   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".200.226   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20.67")]),t._v(".122.249   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":32258/TCP,443:31950/TCP   2m37s\n")])])]),a("p",[t._v("The service "),a("code",[t._v("my-ingress-ingress-nginx-controller")]),t._v(" successfully got a public IP and is now ready to accept traffic. Well, but using an IP adress to navigate to websites/services is not the best option, correct? Let's use a fully-qualified-domain-name (FQND)! The problem is, we haven't registered a domain for our sample. But: you can use a service called "),a("a",{attrs:{href:"https://nip.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("nip.io"),a("OutboundLink")],1),t._v(' that will give you "dynamic routing" by simply adding the IP adress (with dots "." or dashes "-" as seperator) as a subdomain of the domain "nip.io". In the current case, the domain looks like this: '),a("a",{attrs:{href:"http://20-67-122-249.nip.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://20-67-122-249.nip.io/"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("You can test the setup, by opening a browser and navigating to that URL...you should see a page similar to that one.")]),t._v(" "),a("p",[a("img",{attrs:{src:e(760),alt:"default_ingress"}})]),t._v(" "),a("p",[t._v("So, the IP adress of the ingress controller will be the only one exposed in our cluster now. Therefor, we can get rid of the one created in the previuos chapter. To have a clean environment, let's also remove the "),a("code",[t._v("NodePort")]),t._v(" service.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# this one will take some time, because Kubernetes needs to delete the public IP at the Azure Loadbalancer")]),t._v("\n$ kubectl delete "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" loadbalancer-contactsapi\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"loadbalancer-contactsapi"')]),t._v(" deleted\n\n$ kubectl delete "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" nodeport-contactsapi\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nodeport-contactsapi"')]),t._v(" deleted\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# query the service - you should have the 'mssqlsvr' and 'contactsapi' service (ClusterIP)")]),t._v("\n$ kubectl get services\n\nNAME          TYPE        CLUSTER-IP    EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("    AGE\ncontactsapi   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".49.134   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("/TCP   40h\nkubernetes    ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".0.1      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP    6d17h\nmssqlsvr      ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".96.4     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1433")]),t._v("/TCP   40h\n")])])]),a("p",[t._v("Now, let's create an ingress definition for the Contacts API.")]),t._v(" "),a("h2",{attrs:{id:"create-ingress-definitions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-ingress-definitions"}},[t._v("#")]),t._v(" Create Ingress Definitions")]),t._v(" "),a("p",[t._v("The controller has been successfully installed and can accept traffic. We are ready to create an "),a("a",{attrs:{href:"https://kubernetes.io/docs/concepts/services-networking/ingress/",target:"_blank",rel:"noopener noreferrer"}},[t._v("ingress definition"),a("OutboundLink")],1),t._v(" for the Contacts API. To access the service, we want to be able to call an endpoint like that: "),a("a",{attrs:{href:"http://20-67-122-249.nip.io/api/contacts",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://20-67-122-249.nip.io/api/contacts"),a("OutboundLink")],1),t._v(". Therefor, we will be using path-based routing!")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file api-ingress.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.k8s.io/v1beta1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Ingress\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("contacts\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("annotations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kubernetes.io/ingress.class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nginx'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/enable-cors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'true'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/cors-allow-headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,Accept-Language'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/cors-max-age")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'600'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/proxy-body-size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'12m'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/rewrite-target")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/contacts/$2'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/use-regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'true'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 20"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("67"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("122"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("249.nip.io "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# this should be replaced with YOUR OWN DOMAIN")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /api/contacts(\\/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v("$)(."),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("*)")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("serviceName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" contactsapi\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("servicePort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n")])])]),a("p",[t._v("Create the file "),a("code",[t._v("api-ingress.yaml")]),t._v(" and apply it:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("kubectl apply -f api-ingress.yaml\n")])])]),a("p",[t._v("You should now be able to navigate to the adress "),a("a",{attrs:{href:"http://20-67-122-249.nip.io/api/contacts",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://20-67-122-249.nip.io/api/contacts"),a("OutboundLink")],1),t._v(" and get the list of available contacts. Traffic is now managed by the ingress controller and dynamically routed to the "),a("code",[t._v("contactsapi")]),t._v(" service (that is by default not accessible publicly - only now through the ingress controller/definition).")]),t._v(" "),a("p",[a("img",{attrs:{src:e(761),alt:"ingress_contacts"}})]),t._v(" "),a("p",[t._v("As you can see in the ingress definition, we also added a few annotations to influence how the underlying NGINX server is dealing with requests. E.g. enable "),a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#:~:text=Cross%2DOrigin%20Resource%20Sharing%20(CORS)%20is%20a%20mechanism%20that,resources%20from%20a%20different%20origin.",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cross-Origin-Resource-Sharing (CORS)"),a("OutboundLink")],1),t._v(" ("),a("code",[t._v("nginx.ingress.kubernetes.io/enable-cors")]),t._v(") and also define which headers are allowed ("),a("code",[t._v("nginx.ingress.kubernetes.io/cors-allow-headers")]),t._v(") or how long the CORS response is valid until the next CORS request will be sent by the browser ("),a("code",[t._v("nginx.ingress.kubernetes.io/cors-max-age")]),t._v(").")]),t._v(" "),a("p",[t._v("For your information, there is a long list of available annotations you can use with the NGINX ingress controller: "),a("a",{attrs:{href:"https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/"),a("OutboundLink")],1),t._v(". Of course, other ingress controllers support similar definitions.")]),t._v(" "),a("h2",{attrs:{id:"add-the-ui"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-the-ui"}},[t._v("#")]),t._v(" Add the UI")]),t._v(" "),a("p",[t._v('So, just having an API is pretty boring. Of course there is also a UI service, that is able to interact with the API. Let\'s also add that component to our cluster to have a "real-life setup". Go to the folder '),a("code",[t._v("day7/apps/frontend/scmfe/public/settings")]),t._v(" and adjust the settings.js file for the frontend. We need to tell the Single Page Application, where to access the Contacts API.")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" uisettings "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  endpoint"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://<YOUR_NIP_DOMAIN>/api/contacts/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  enableStats"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  aiKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("In the current sample, the file looks like that:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" uisettings "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  endpoint"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://20-67-122-249.nip.io/api/contacts/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  enableStats"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  aiKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Save the file and - in a terminal - go to the folder "),a("code",[t._v("day7/apps/frontend/scmfe")]),t._v(" and build/publish the Docker image:")]),t._v(" "),a("p",[a("strong",[t._v("Alternative 1 - Build locally:")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker build -t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/adc-frontend-ui:1.0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\ndocker push "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/adc-frontend-ui:1.0\n")])])]),a("p",[a("strong",[t._v("Alternative 2 - Use your Azure Container Registry:")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("az acr build -r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" -t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ACR_NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".azurecr.io/adc-frontend-ui:1.0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),a("p",[t._v("As soon as the image is present in your registry, let's deploy it to the cluster. We need three definitions: a deployment, a "),a("code",[t._v("ClusterIP")]),t._v(" service and an ingress object. This time, we will deploy everything via one file, separating each object by "),a("code",[t._v("---")]),t._v(".")]),t._v(" "),a("p",[t._v("Don't forget to "),a("strong",[t._v("adjust the the ingress host")]),t._v(" to the domain you are using.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Content of file frontend.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfrontend\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfrontend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfrontend\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfrontend\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <ACR_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(".azurecr.io/adc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("frontend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ui"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'128Mi'")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'500m'")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" frontend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfrontend\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterIP\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfrontend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.k8s.io/v1beta1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Ingress\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("frontend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("annotations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kubernetes.io/ingress.class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nginx'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/enable-cors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'true'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/cors-allow-headers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,Accept-Language'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/cors-max-age")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'600'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx.ingress.kubernetes.io/proxy-body-size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'12m'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 20"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("67"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("122"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("249.nip.io "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# this should be replaced with YOUR OWN DOMAIN")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("serviceName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" frontend\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("servicePort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n")])])]),a("p",[t._v("Create a file called "),a("code",[t._v("frontend.yaml")]),t._v(" with the content above and apply it:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -f frontend.yaml\n\ndeployment.apps/myfrontend created\nservice/frontend created\ningress.networking.k8s.io/ing-frontend created\n")])])]),a("p",[t._v("Please check, that everything is in place:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get deployment,service,endpoints,ingress\nNAME                               READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/mssql-deployment   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("           2d2h\ndeployment.apps/myapi              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("/4     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("           2d1h\ndeployment.apps/myfrontend         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("           3m5s\n\nNAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("    AGE\nservice/contactsapi   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".49.134    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("/TCP   43h\nservice/frontend      ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".124.132   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("/TCP   3m5s\nservice/kubernetes    ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".0.1       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP    6d21h\nservice/mssqlsvr      ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".96.4      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1433")]),t._v("/TCP   43h\n\nNAME                    ENDPOINTS                                                        AGE\nendpoints/contactsapi   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.38:5000,10.244.1.15:5000,10.244.1.16:5000 + "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" more"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".   43h\nendpoints/frontend      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.39:80                                                   3m5s\nendpoints/kubernetes    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20.50")]),t._v(".162.80:443                                                 6d21h\nendpoints/mssqlsvr      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.5:1433                                                  43h\n\nNAME                              HOSTS                  ADDRESS         PORTS   AGE\ningress.extensions/ing-contacts   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("-67-122-249.nip.io   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20.67")]),t._v(".122.249   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("      45m\ningress.extensions/ing-frontend   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("-67-122-249.nip.io   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20.67")]),t._v(".122.249   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("      3m5s\n")])])]),a("p",[t._v("That looks good, now open a browser and navigate to the website (here: "),a("a",{attrs:{href:"http://20-67-122-249.nip.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://20-67-122-249.nip.io/"),a("OutboundLink")],1),t._v("), open the contacts list, create/modify a contact etc.")]),t._v(" "),a("p",[a("img",{attrs:{src:e(762),alt:"ui_home"}}),t._v(" "),a("img",{attrs:{src:e(763),alt:"ui_list"}}),t._v(" "),a("img",{attrs:{src:e(764),alt:"ui_detail"}})]),t._v(" "),a("h2",{attrs:{id:"wrap-up"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#wrap-up"}},[t._v("#")]),t._v(" Wrap-Up")]),t._v(" "),a("p",[t._v('Congratulations, you have deployed a full-blown application to Kubernetes with a SQL server running inside the cluster. As you might guess, there are a few things now that need to be adjusted. E.g. we added some of the configuration settings - even worse, passwords! - "hard-coded" to manifest files. Also the endpoint configuration for the UI has been baked into the image. In the next challenge, we will adress these issues by using Kubernetes '),a("code",[t._v("ConfigMaps")]),t._v(" and "),a("code",[t._v("Secrets")]),t._v('. You will learn how to configure your application "from outside" by using standard Kubernetes objects.')])])}),[],!1,null,null,null);s.default=n.exports}}]);